(()=>{"use strict";(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__preview img"),s=e.querySelector(".effect-level"),o=e.querySelector(".scale__control--value"),n=e.querySelector(".effect-level__value"),r=e.querySelector(".effect-level__pin"),i=e.querySelector(".effect-level__depth"),c=e.querySelector("#effect-none"),l=document.querySelector(".img-filters");window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},generateRandomNumber:(e,t)=>Math.floor(e+Math.random()*(t+1-e)),shufflePhotos:e=>{let t=0;for(let s=e.length-1;s>0;s--){const o=Math.floor(Math.random()*(s+1));t=e[s],e[s]=e[o],e[o]=t}return e},resetUserImgSettings:()=>{s.classList.add("hidden"),t.removeAttribute("class"),t.style.transform="scale(1)",t.removeAttribute("style"),o.value="100%",n.value=100,r.style.left="100%",i.style.width="100%"},resetForm:()=>{e.reset(),c.checked=!0},onError:e=>{const t=document.createElement("div");t.style.position="absolute",t.style.top="90px",t.style.left="0",t.style.right="0",t.style.zIndex="100",t.style.width="790px",t.style.height="90px",t.style.margin="0 auto",t.style.paddingTop="30px",t.style.fontSize="35px",t.style.fontWeight="700",t.style.textAlign="center",t.style.color="#ffe753",t.style.backgroundColor="#3c3614",t.style.border="5px solid #ff4d4d",t.style.borderRadius="10px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t),t.addEventListener("click",(()=>{t.remove()})),l.classList.add("visually-hidden")},imageUploadForm:e,userUploadImg:t,effectSlider:s,scaleIndicator:o,effectValueInput:n,pin:r,effectDepth:i,imgFilters:l,maxEffectValue:100}})(),window.timeout={debounce:e=>{let t=null;return(...s)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...s)}),500)}}},(()=>{const{isEscEvent:e}=window.utils,t=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("main"),o=()=>{s.querySelector(".success").remove(),document.removeEventListener("keydown",i)},n=()=>{o()},r=e=>{e.stopPropagation(),e.target.classList.contains("success")&&o()},i=t=>{e(t,o)};window.success={openСongratulationMessage:()=>{const e=t.cloneNode(!0);s.append(e);const o=e.querySelector(".success__button");o.addEventListener("click",n),e.addEventListener("click",r),document.addEventListener("keydown",i),o.focus()},main:s}})(),(()=>{const{isEscEvent:e}=window.utils,{main:t}=window.success,s=document.querySelector("#error").content.querySelector(".error"),o=()=>{t.querySelector(".error").remove(),document.removeEventListener("keydown",i)},n=()=>{o()},r=e=>{e.stopPropagation(),e.target.classList.contains("error")&&o()},i=t=>{e(t,o)};window.mistake={openErrorMessage:()=>{const e=s.cloneNode(!0);t.append(e);const o=e.querySelector(".error__button");o.addEventListener("click",n),e.addEventListener("click",r),document.addEventListener("keydown",i),o.focus()}}})(),(()=>{const e=(e,t,s,o,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.timeout=1e4,r.open(e,t),r.send(s),r.addEventListener("load",(()=>{200===r.status?o(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout} мс`)}))};window.backend={load(t,s){e("GET","https://21.javascript.pages.academy/kekstagram/data",null,t,s)},save(t,s,o){e("POST","https://21.javascript.pages.academy/kekstagram",t,s,o)}}})(),(()=>{const e=document.querySelector(".social__comments"),t=document.querySelector(".big-picture"),s=t.querySelector(".social__comment-count"),o=t.querySelector(".comments-loader");let n=[],r=0;const i=t=>{t.forEach((t=>{const s=(e=>`<li class="social__comment">\n      <img class="social__picture" width="35" height="35" src="${e.avatar}" alt="${e.name}">\n      <p class="social__text">${e.message}</p>\n      </li>`)(t);e.insertAdjacentHTML("beforeend",s)})),(e=>{s.textContent="";const t=`${e} из <span class="comments-count">${r}</span> комментариев`;s.insertAdjacentHTML("afterbegin",t)})(e.querySelectorAll(".social__comment").length)};window.comments={onSocialLoadMore:()=>{i(n.splice(0,5)),0===n.length&&o.classList.add("visually-hidden")},renderList:e=>{n=e.comments.slice(),r=e.comments.length,n.length>5?(s.classList.remove("visually-hidden"),o.classList.remove("visually-hidden"),i(n.splice(0,5))):(s.classList.add("visually-hidden"),o.classList.add("visually-hidden"),i(n))},removeSocial:()=>{e.querySelectorAll(".social__comment").forEach((t=>{e.removeChild(t)}))},bigPhoto:t,commentsLoader:o}})(),(()=>{const{isEscEvent:e,shufflePhotos:t,onError:s,imgFilters:o}=window.utils,{onSocialLoadMore:n,renderList:r,removeSocial:i,bigPhoto:c,commentsLoader:l}=window.comments,{debounce:a}=window.timeout,{load:d}=window.backend,u=document.querySelector(".img-filters__form"),m=c.querySelector(".big-picture__cancel"),v=document.querySelectorAll(".img-filters__button"),p=document.querySelector(".pictures"),f=document.querySelector("#picture").content.querySelector(".picture"),g=document.querySelector("body"),y=e=>{const t=document.createDocumentFragment();e.forEach((e=>{t.append(S(e))})),p.append(t)};let h=[];const L=e=>{((e,t)=>{if(!e.target.matches(".picture")&&!e.target.matches(".picture__img"))return;const s=t.find((t=>t.url===e.target.closest(".picture").children[0].attributes.src.value));k(s)})(e,h)};d((e=>{h=e,y(e),o.classList.remove("img-filters--inactive")}),s);const w=()=>{p.querySelectorAll(".picture").forEach((e=>{e.remove()}))},_={"filter-default":()=>{w(),y(h)},"filter-random":()=>{w();const e=h.slice();y((10,t(e.slice()).slice(0,10)))},"filter-discussed":()=>{w();const e=h.slice().sort(((e,t)=>t.comments.length-e.comments.length));y(e)}},E=a((e=>{v.forEach((e=>{e.classList.contains("img-filters__button--active")&&e.classList.remove("img-filters__button--active")})),e.target.classList.add("img-filters__button--active"),_[e.target.id]()}));u.addEventListener("click",E);const S=e=>{const t=f.cloneNode(!0);return t.querySelector("img").src=e.url,t.querySelector("img").alt=e.description,t.querySelector(".picture__likes").textContent=e.likes,t.querySelector(".picture__comments").textContent=e.comments.length,t};p.addEventListener("click",L);const k=e=>{c.classList.remove("hidden"),g.classList.add("modal-open"),m.focus(),c.querySelector(".big-picture__img").querySelector("img").src=e.url,c.querySelector(".big-picture__img").querySelector("img").alt=e.description,c.querySelector(".likes-count").textContent=e.likes,c.querySelector(".comments-count").textContent=e.comments.length,c.querySelector(".social__caption").textContent=e.description,i(),r(e),u.removeEventListener("click",E),p.removeEventListener("click",L),l.addEventListener("click",n),m.addEventListener("click",q),document.addEventListener("keydown",b)},q=()=>{c.classList.add("hidden"),g.removeAttribute("class"),u.addEventListener("click",E),p.addEventListener("click",L),l.removeEventListener("click",n),m.removeEventListener("click",q),document.removeEventListener("keydown",b)},b=t=>{e(t,q)};window.gallery={onFilterButtonClick:E,photosList:p,body:g,onPictureImgOpenBigPicture:L,imageFiltersForm:u}})(),(()=>{const e=["gif","jpg","jpeg","png"],{imageUploadForm:t,userUploadImg:s,effectSlider:o}=window.utils,{openErrorMessage:n}=window.mistake,r=t.querySelector(".img-upload__input"),i=t.querySelector(".img-upload__overlay"),c=i.querySelectorAll(".effects__preview"),l=()=>{const t=r.files[0].name.toLowerCase();return e.some((e=>t.endsWith(e)))};window.fileChoser={FILE_TYPES:e,addUserPhoto:()=>{o.classList.add("hidden");const e=r.files[0];if(l()){const t=new FileReader;t.addEventListener("load",(()=>{s.src=t.result,c.forEach((e=>{e.style.backgroundImage=`url(${t.result})`})),i.classList.remove("hidden")})),t.readAsDataURL(e)}else n()},editingUploadImage:i,imageUploadInput:r,checksFileType:l,effectsPreviewImages:c}})(),(()=>{const{imageUploadForm:e}=window.utils,t=e.querySelector(".text__hashtags"),s=/[^A-Za-z0-9А-Яа-я]/,o=()=>{const e=t.value.trim().split(" "),o=[],n=e=>{const t=e.toLowerCase();let s=!1;return-1!==o.indexOf(t)&&(s=!0),o.push(t),s};if(""!==t.value.trim())for(let o=0;o<e.length;o++){const r=e[o];if("#"!==r[0])return void t.setCustomValidity(`${o+1} хэш-тег (${r}) должен начинаться с символа # (решётка)`);if(","===r.slice(-1))return void t.setCustomValidity("Хэш-теги разделяются пробелами");if(s.test(r.replace("#","")))return void t.setCustomValidity(`Строка после символа # (решётка) должна состоять только из букв и чисел. Пробелы, эмодзи, спецсимволы (#, @, $, - и т. п.) не допустимы. ${o+1} хэш-тег с ошибкой`);if("#"===r[0]&&1===r.length)return void t.setCustomValidity(`${o+1} хэш-тег (${r}) не может состоять только из одной символа ${r} (решётка)`);if(r.length>20)return void t.setCustomValidity("Максимальная длина одного хэш-тега 20 символов, включая решётку");if(!(o<5))return void t.setCustomValidity("Нельзя указать больше 5 хэш-тегов");if(n(r))return void t.setCustomValidity("Один и тот же хэш-тег не может быть использован дважды. Хэш-теги нечувствительны к регистру. #ХэшТег и #хэштег считаются одним и тем же тегом");t.setCustomValidity("")}else t.setCustomValidity("")};o(),window.validation={onHashtagsInputСhecks:o,hashtagsInput:t}})(),(()=>{const{imageUploadForm:e,maxEffectValue:t,effectValueInput:s,pin:o,effectDepth:n}=window.utils,r=e.querySelector(".effect-level__line");window.dragAndDrop={onMouseDown:(e,i)=>{e.preventDefault();const c={x:e.clientX},l=e=>{e.preventDefault();const l=c.x-e.clientX;c.x=e.clientX;let a=o.offsetLeft-l;a>r.offsetWidth?a=r.offsetWidth:a<=0&&(a=0),o.style.left=a+"px",s.value=Math.round(o.offsetLeft*t/r.offsetWidth),n.style.width=s.value+"%",i()},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",a)},pin:o}})(),(()=>{const{resetUserImgSettings:e,imageUploadForm:t,userUploadImg:s,effectSlider:o,effectValueInput:n}=window.utils,{onMouseDown:r,pin:i}=window.dragAndDrop,c=t.querySelector(".effects"),l=t.querySelector(".effects__list"),a=e=>{r(e,d)},d=()=>{switch(c.querySelector("input:checked").value){case"chrome":s.style.filter=`grayscale(${.01*n.value})`;break;case"sepia":s.style.filter=`sepia(${.01*n.value})`;break;case"marvin":s.style.filter=`invert(${n.value}%)`;break;case"phobos":s.style.filter=`blur(${.03*n.value}px)`;break;case"heat":s.style.filter=`brightness(${.02*n.value+1})`}};window.photoFilter={onSliderEffectChange:()=>{e(),(()=>{switch("none"!==c.querySelector("input:checked").value?(o.classList.remove("hidden"),i.addEventListener("mousedown",a)):i.removeEventListener("mousedown",a),c.querySelector("input:checked").value){case"chrome":s.classList.add("effects__preview--chrome");break;case"sepia":s.classList.add("effects__preview--sepia");break;case"marvin":s.classList.add("effects__preview--marvin");break;case"phobos":s.classList.add("effects__preview--phobos");break;case"heat":s.classList.add("effects__preview--heat")}})()},onEffectLevelPinMove:a,effectsList:l}})(),(()=>{const{imageUploadForm:e,maxEffectValue:t,userUploadImg:s,scaleIndicator:o}=window.utils,n=e.querySelector(".scale__control--smaller"),r=e.querySelector(".scale__control--bigger");window.zoomPhoto={onButtonIncreaseImage:()=>{let e=Number(o.value.slice(0,o.value.length-1));e<t&&(e+=25),o.value=e+"%",s.style.transform=`scale(${e/t})`},onButtonDecreaseImage:()=>{let e=Number(o.value.slice(0,o.value.length-1));e>25&&(e-=25),o.value=e+"%",s.style.transform=`scale(${e/t})`},buttonIncreaseImgScale:r,buttonDecreaseImgScale:n}})(),(()=>{const{isEscEvent:e,resetUserImgSettings:t,imageUploadForm:s,userUploadImg:o,resetForm:n}=window.utils,{save:r}=window.backend,{openСongratulationMessage:i}=window.success,{openErrorMessage:c}=window.mistake,{addUserPhoto:l,checksFileType:a,editingUploadImage:d,imageUploadInput:u,effectsPreviewImages:m}=window.fileChoser,{pin:v}=window.dragAndDrop,{onButtonIncreaseImage:p,onButtonDecreaseImage:f,buttonIncreaseImgScale:g,buttonDecreaseImgScale:y}=window.zoomPhoto,{onSliderEffectChange:h,effectsList:L,onEffectLevelPinMove:w}=window.photoFilter,{hashtagsInput:_,onHashtagsInputСhecks:E}=window.validation,{onFilterButtonClick:S,imageFiltersForm:k,onPictureImgOpenBigPicture:q,photosList:b,body:I}=window.gallery,x=s.querySelector(".img-upload__cancel"),C=document.querySelector("#messages").content,F=s.querySelector(".text__description"),$=document.querySelector(".img-upload"),U=o.attributes.src.value,A=()=>{I.classList.add("modal-open"),t(),l(),a()&&(u.removeEventListener("change",A),b.removeEventListener("click",q),k.removeEventListener("click",S)),x.addEventListener("click",P),y.addEventListener("click",f),g.addEventListener("click",p),L.addEventListener("click",h),document.addEventListener("keydown",D),_.addEventListener("invalid",E),_.addEventListener("input",E),s.addEventListener("submit",B)};u.addEventListener("change",A);const P=()=>{t(),n(),o.src=U,m.forEach((e=>{e.removeAttribute("style")})),d.classList.add("hidden"),I.removeAttribute("class"),u.addEventListener("change",A),k.addEventListener("click",S),b.addEventListener("click",q),x.removeEventListener("click",P),y.removeEventListener("click",f),g.removeEventListener("click",p),L.removeEventListener("click",h),document.removeEventListener("keydown",D),v.removeEventListener("mousedown",w),_.removeEventListener("invalid",E),_.removeEventListener("input",E),s.removeEventListener("submit",B)},D=t=>{_.matches(":focus")||F.matches(":focus")||e(t,P)},M=s.querySelector(".img-upload__message.img-upload__message--loading");M&&M.classList.add("overlay");const V=()=>{$.classList.remove("overlay"),I.removeAttribute("class"),$.querySelector(".img-upload__message").remove()},T=()=>{V(),i()},j=()=>{V(),P(),c()},B=e=>{e.preventDefault(),P(),(()=>{const e=C.cloneNode(!0);s.append(e),$.classList.add("overlay"),I.classList.add("modal-open")})();const t=new FormData(s);r(t,T,j)}})()})();